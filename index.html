<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromptPocket AI</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
            color: #F9FAFB; /* Tailwind gray-50 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        .prompt-card-content { white-space: pre-wrap; word-break: break-word; }
        /* Hide main app by default */
        #main-app { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md text-center">
             <h1 class="text-5xl font-bold text-white tracking-tight">
                <span class="text-indigo-400">PromptPocket</span> AI
            </h1>
            <p class="mt-2 text-lg text-gray-400 mb-8">Acesse sua carteira de prompts.</p>

            <div class="bg-gray-800 p-8 rounded-2xl shadow-lg">
                <form id="email-login-form" class="space-y-4">
                    <input type="email" id="email-input" placeholder="Seu e-mail" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required>
                    <input type="password" id="password-input" placeholder="Sua senha" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                        Entrar ou Registrar
                    </button>
                </form>

                <div class="my-4 flex items-center">
                    <hr class="w-full border-gray-600">
                    <span class="px-2 text-gray-400">OU</span>
                    <hr class="w-full border-gray-600">
                </div>

                <button id="google-login-btn" class="w-full bg-white hover:bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-6 h-6 mr-3">
                    Entrar com Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="w-full max-w-6xl flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white tracking-tight">
                <span class="text-indigo-400">PromptPocket</span> AI
            </h1>
            <div id="user-info" class="flex items-center">
                 <!-- User info will be injected here -->
            </div>
        </header>

        <main class="w-full max-w-6xl grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-8 flex-grow">
            
            <!-- Left Column: Forms & Category Management -->
            <div class="md:col-span-1 lg:col-span-1">
                 <!-- Add/Edit Prompt Form -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg sticky top-8 mb-8">
                    <h2 id="form-title" class="text-2xl font-semibold mb-4 text-white">Adicionar Prompt</h2>
                    <form id="prompt-form" class="space-y-4">
                        <input type="text" id="prompt-title" placeholder="Título do Prompt" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required>
                        <select id="prompt-category-select" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required>
                            <option value="">Selecione uma categoria...</option>
                        </select>
                        <textarea id="prompt-text" rows="6" placeholder="Seu prompt aqui..." class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required></textarea>
                        <input type="url" id="prompt-link" placeholder="https://... (Link da conversa, opcional)" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                        <div id="form-buttons">
                            <button type="submit" id="save-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">Salvar</button>
                            <div id="edit-buttons" class="hidden">
                                <button type="submit" id="update-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">Atualizar</button>
                                <button type="button" id="cancel-edit-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg transition">Cancelar</button>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- Category Management -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg sticky top-[30rem]">
                     <h2 class="text-2xl font-semibold mb-4 text-white">Categorias</h2>
                     <form id="add-category-form" class="flex gap-2 mb-4">
                        <input type="text" id="category-name" placeholder="Nova categoria" class="w-full bg-gray-700 text-white rounded-lg p-3 focus:ring-2 focus:ring-indigo-500" required>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-lg transition"><i class="fas fa-plus"></i></button>
                     </form>
                     <div id="category-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Category list will be injected here -->
                     </div>
                </div>
            </div>

            <!-- Right Column: Prompt List & Search -->
            <div class="md:col-span-2 lg:col-span-3">
                <div class="relative mb-4">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fas fa-search text-gray-400"></i>
                    </span>
                    <input type="search" id="search-input" placeholder="Buscar prompts..." class="w-full bg-gray-800 text-white rounded-lg py-3 pl-10 pr-4 focus:ring-2 focus:ring-indigo-500">
                </div>
                <div id="prompt-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                    <!-- Prompt cards will be injected here -->
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="w-full max-w-6xl text-center text-gray-500 py-6 mt-8">
            <p>Desenvolvido por Vinicius Ferraz</p>
        </footer>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary functions from Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, doc, 
            deleteDoc, updateDoc, serverTimestamp, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION & STATE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDatDCuPP5zVV-NsbV0n6ExLvb3UTWhdlc",
            authDomain: "prompt-pocket-ai.firebaseapp.com",
            projectId: "prompt-pocket-ai",
            storageBucket: "prompt-pocket-ai.appspot.com",
            messagingSenderId: "565506955883",
            appId: "1:565506955883:web:53173d1f0b0f20958a74e6"
        };
        
        // App state
        let db, auth, userId, userEmail, userPhotoURL;
        let promptsCollectionRef, categoriesCollectionRef;
        let unsubscribePrompts, unsubscribeCategories;
        let allPrompts = [], allCategories = [];
        let currentEditingId = null;

        // UI Elements
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const emailLoginForm = document.getElementById('email-login-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const userInfo = document.getElementById('user-info');
        const promptForm = document.getElementById('prompt-form');
        const promptTitleInput = document.getElementById('prompt-title');
        const promptCategorySelect = document.getElementById('prompt-category-select');
        const promptTextInput = document.getElementById('prompt-text');
        const promptLinkInput = document.getElementById('prompt-link');
        const promptList = document.getElementById('prompt-list');
        const searchInput = document.getElementById('search-input');
        const formTitle = document.getElementById('form-title');
        const saveBtn = document.getElementById('save-btn');
        const editButtons = document.getElementById('edit-buttons');
        const updateBtn = document.getElementById('update-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryNameInput = document.getElementById('category-name');
        const categoryListDiv = document.getElementById('category-list');
        const toast = document.getElementById('toast');

        // --- 2. FIREBASE INITIALIZATION & AUTHENTICATION ---
        function initializeAppCore() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setupAuthListener();
            } catch(e) {
                console.error("Firebase initialization failed", e);
                document.body.innerHTML = "<h1>Erro Crítico: Falha ao conectar com o Firebase. Verifique a configuração.</h1>";
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    userEmail = user.email;
                    userPhotoURL = user.photoURL;
                    
                    loginPage.style.display = 'none';
                    mainApp.style.display = 'flex';

                    renderUserInfo();
                    
                    promptsCollectionRef = collection(db, `users/${userId}/prompts`);
                    categoriesCollectionRef = collection(db, `users/${userId}/categories`);
                    listenForData();
                } else {
                    // User is signed out
                    userId = null;
                    mainApp.style.display = 'none';
                    loginPage.style.display = 'flex';
                    if (unsubscribePrompts) unsubscribePrompts();
                    if (unsubscribeCategories) unsubscribeCategories();
                }
            });
        }

        // --- AUTHENTICATION HANDLERS ---
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google login failed", error);
                showToast(`Erro no login: ${error.message}`, true);
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } catch (createError) {
                        showToast(`Falha ao registrar: ${createError.message}`, true);
                    }
                } else {
                    showToast(`Falha no login: ${error.message}`, true);
                }
            }
        }
        
        async function handleLogout() {
            await signOut(auth);
        }

        // --- 3. DATA HANDLING ---
        function listenForData() {
            listenForCategories();
            listenForPrompts();
        }

        function listenForCategories() {
            if (unsubscribeCategories) unsubscribeCategories();
            const q = query(categoriesCollectionRef);
            unsubscribeCategories = onSnapshot(q, snapshot => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
                populateCategorySelect();
            });
        }

        function listenForPrompts() {
            if (unsubscribePrompts) unsubscribePrompts();
            const q = query(promptsCollectionRef);
            unsubscribePrompts = onSnapshot(q, snapshot => {
                allPrompts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayFilteredPrompts();
            });
        }

        async function handleAddCategory(e) {
            e.preventDefault();
            const categoryName = categoryNameInput.value.trim();
            if (categoryName) {
                try {
                    await addDoc(categoriesCollectionRef, { name: categoryName });
                    categoryNameInput.value = '';
                } catch (error) {
                    console.error("Error adding category:", error);
                    showToast("Falha ao adicionar categoria.", true);
                }
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const promptData = {
                title: promptTitleInput.value.trim(),
                categoryId: promptCategorySelect.value,
                text: promptTextInput.value.trim(),
                link: promptLinkInput.value.trim(),
            };

            if (!promptData.categoryId) {
                showToast("Por favor, selecione uma categoria.", true);
                return;
            }

            if (currentEditingId) { // Update
                try {
                    const docRef = doc(db, `users/${userId}/prompts`, currentEditingId);
                    await updateDoc(docRef, promptData);
                    showToast("Prompt atualizado!");
                    resetForm();
                } catch (error) {
                    console.error("Update Error:", error);
                    showToast("Falha ao atualizar.", true);
                }
            } else { // Add new
                try {
                    await addDoc(promptsCollectionRef, { ...promptData, createdAt: serverTimestamp() });
                    showToast("Prompt salvo!");
                    resetForm(true);
                } catch (error) {
                    console.error("Add Error:", error);
                    showToast("Falha ao salvar.", true);
                }
            }
        }
        
        async function deletePrompt(id) {
            if (confirm("Tem certeza que deseja deletar este prompt?")) {
                try {
                    await deleteDoc(doc(db, `users/${userId}/prompts`, id));
                    showToast("Prompt deletado.");
                } catch (error) {
                    showToast("Falha ao deletar.", true);
                }
            }
        }

        // --- 4. UI RENDERING & INTERACTIONS ---
        function renderUserInfo() {
            const photo = userPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userEmail)}&background=random`;
            userInfo.innerHTML = `
                <span class="mr-4 text-gray-300 hidden sm:inline">${userEmail}</span>
                <img src="${photo}" alt="User Avatar" class="w-10 h-10 rounded-full mr-4">
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    Sair
                </button>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        function renderCategories() {
            categoryListDiv.innerHTML = allCategories.map(cat => `
                <div class="bg-gray-700 p-2 rounded-lg text-sm text-center">${escapeHTML(cat.name)}</div>
            `).join('');
        }
        
        function populateCategorySelect() {
            const currentSelection = promptCategorySelect.value;
            promptCategorySelect.innerHTML = '<option value="">Selecione uma categoria...</option>';
            allCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                promptCategorySelect.appendChild(option);
            });
            promptCategorySelect.value = currentSelection;
        }

        function displayFilteredPrompts() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredPrompts = allPrompts.filter(prompt =>
                prompt.title.toLowerCase().includes(searchTerm) ||
                prompt.text.toLowerCase().includes(searchTerm)
            );
            renderPrompts(filteredPrompts);
        }

        function renderPrompts(prompts) {
             if (prompts.length === 0 && allPrompts.length > 0) {
                promptList.innerHTML = `<p class="text-gray-400 col-span-full text-center">Nenhum prompt encontrado para sua busca.</p>`;
                return;
            }
             if (allPrompts.length === 0) {
                 promptList.innerHTML = `<p class="text-gray-400 col-span-full text-center">Você ainda não tem prompts. Adicione um!</p>`;
                 return;
            }
            promptList.innerHTML = prompts.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0))
            .map(prompt => {
                const category = allCategories.find(c => c.id === prompt.categoryId);
                const categoryTag = category ? `<span class="bg-indigo-500 text-indigo-50 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${escapeHTML(category.name)}</span>` : '';
                const linkTag = prompt.link ? `<a href="${escapeHTML(prompt.link)}" target="_blank" class="text-blue-400 hover:underline text-sm mt-2 block"><i class="fas fa-link mr-1"></i> Ver Conversa</a>` : '';

                return `
                <div class="bg-gray-800 p-5 rounded-2xl shadow-lg flex flex-col" data-prompt-id="${prompt.id}">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-white break-words">${escapeHTML(prompt.title)}</h3>
                            <div class="flex-shrink-0 ml-2">
                                <button data-action="edit" class="text-gray-400 hover:text-blue-400 p-1"><i class="fas fa-pencil-alt"></i></button>
                                <button data-action="delete" class="text-gray-400 hover:text-red-500 p-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center mb-2">${categoryTag}</div>
                        <p class="text-gray-300 mb-2 prompt-card-content">${escapeHTML(prompt.text)}</p>
                        ${linkTag}
                    </div>
                    <div class="flex items-center justify-end mt-auto pt-4 border-t border-gray-700">
                        <button data-action="copy" class="copy-btn bg-gray-700 hover:bg-indigo-600 text-gray-200 font-semibold py-2 px-4 rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-copy"></i><span>Copiar</span>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function handleListClick(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const card = button.closest('[data-prompt-id]');
            const id = card?.dataset.promptId;
            if (!id) return;
            const promptToActOn = allPrompts.find(p => p.id === id);

            switch (action) {
                case 'copy': copyToClipboard(promptToActOn.text, button); break;
                case 'delete': deletePrompt(id); break;
                case 'edit': enterEditMode(promptToActOn); break;
            }
        }
        
        function enterEditMode(prompt) {
            currentEditingId = prompt.id;
            formTitle.textContent = "Editar Prompt";
            promptTitleInput.value = prompt.title;
            promptCategorySelect.value = prompt.categoryId;
            promptTextInput.value = prompt.text;
            promptLinkInput.value = prompt.link || '';
            saveBtn.classList.add('hidden');
            editButtons.classList.remove('hidden');
            promptForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetForm(clearInputs = true) {
            currentEditingId = null;
            formTitle.textContent = "Adicionar Novo Prompt";
            if (clearInputs) promptForm.reset();
            saveBtn.classList.remove('hidden');
            editButtons.classList.add('hidden');
        }

        // --- UTILITY FUNCTIONS ---
        function copyToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Prompt copiado!");
                if (buttonElement) {
                    const span = buttonElement.querySelector('span');
                    if (span) {
                        span.textContent = 'Copiado!';
                        setTimeout(() => { span.textContent = 'Copiar'; }, 2000);
                    }
                }
            }, () => {
                showToast("Falha ao copiar.", true);
            });
        }

        function showToast(message, isError = false) {
            toast.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i> ${message}`;
            toast.className = `fixed bottom-10 right-10 text-white py-3 px-6 rounded-lg shadow-xl transform transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0`;
            setTimeout(() => {
                toast.classList.replace('opacity-100', 'opacity-0');
                toast.classList.replace('translate-y-0', 'translate-y-20');
            }, 3000);
        }

        function escapeHTML(str) {
            return str?.replace(/[&<>"']/g, function (tag) {
                const replacements = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return replacements[tag] || tag;
            }) || '';
        }

        // --- 5. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', initializeAppCore);
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        emailLoginForm.addEventListener('submit', handleEmailLogin);
        promptForm.addEventListener('submit', handleFormSubmit);
        addCategoryForm.addEventListener('submit', handleAddCategory);
        promptList.addEventListener('click', handleListClick);
        searchInput.addEventListener('input', displayFilteredPrompts);
        cancelEditBtn.addEventListener('click', () => resetForm(true));

    </script>
</body>
</html>
